name: Tag and push new version (dev)

on:
  push:
    branches:
      - dev

jobs:
  tag-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'
      - name: Cache jq
        uses: actions/cache@v3
        env:
          cache-name: cache-jq
        with:
          path: ~/.cache/jq
          key: ${{ runner.os }}-${{ hashFiles('jq') }}
          restore-keys: |
            ${{ runner.os }}-jq-
      - name: Install jq
        run: |
          if ! command -v jq > /dev/null; then
            sudo apt-get update
            sudo apt-get install jq
          fi
      - name: Check last commit message
        id: commit
        run: |
          COMMIT_MESSAGE=$(git log --format=%B -n 1)
          if [[ $COMMIT_MESSAGE == bump* ]]; then
          echo "Skipping workflow as commit message starts with 'bump'"
          echo "SKIP_WORKFLOW=true" >> $GITHUB_ENV
          fi
      - name: Halt job if commit message starts with 'bump'
        run: |
          if [[ "${{ env.SKIP_WORKFLOW }}" == "true" ]]; then
            echo "Job halted"
            exit 1
          fi
      - name: Bump npm version based on last commit message
        id: bump_version
        run: |
          echo "start!"
          git config --global user.email "yoojehwan1875@gmail.com"
          git config --global user.name "JeHwanYoo"
          git fetch --tags
          
          LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$LAST_COMMIT_MSG" =~ ^docs.* ]] || [[ "$LAST_COMMIT_MSG" =~ ^chore.* ]]
          then
            echo "no bump"
            exit 0
          fi
          
          LAST_RC_VERSION=$(git tag --list '*rc.*' | sort -V | tail -n1)
          LAST_RC_VERSION="${LAST_RC_VERSION#v}" # Remove 'v' prefix from version
          LAST_RC_VERSION_WITHOUT_SUFFIX="${LAST_RC_VERSION%%-*}" # Remove '-rc', '-feat', '-fix', etc. suffix from version

          FULL_VERSION=$(git describe --tags `git rev-list --tags --max-count=1`)
          CURRENT_VERSION="${FULL_VERSION%%-*}" # Remove suffix starting from '-'
          CURRENT_VERSION="${CURRENT_VERSION#v}" # Remove 'v' prefix from version
          
          echo LAST_RC_VERSION_WITHOUT_SUFFIX $LAST_RC_VERSION_WITHOUT_SUFFIX
          echo CURRENT_VERSION $CURRENT_VERSION

          if [[ $LAST_RC_VERSION_WITHOUT_SUFFIX != $CURRENT_VERSION ]]
          then
            echo not equal
            NEW_VERSION="${CURRENT_VERSION}-rc.0"
          else
            echo equal
            RC_NUMBER="${LAST_RC_VERSION##*.}"
            NEW_RC_NUMBER=$((RC_NUMBER + 1))
            NEW_VERSION="${LAST_RC_VERSION%.*}.${NEW_RC_NUMBER}"
          fi
          echo NEW_VERSION $NEW_VERSION
          npm version ${NEW_VERSION} --no-git-tag-version
          echo "VERSION=${NEW_VERSION}" >> $GITHUB_ENV
      - name: Commit changes
        run: |
          if [ -n "${{ env.VERSION }}" ]
          then
            git add .
            git commit -m "bump: ${{ env.VERSION }}"
            git push origin dev --force
          fi
      - name: Create tag
        run: |
          if [ -n "${{ env.VERSION }}" ]
          then
            git tag -f v${{ env.VERSION }}
            git push --tags --force
            git fetch origin
            git checkout local
            git reset --hard origin/dev
            git push origin local --force
          fi
      - name: Create Release Note
        run: |
          if [ -n "${{ env.VERSION }}" ]
          then
            PRERELEASE=${{ env.isPrerelease }}
            curl --request POST \
              --url https://api.github.com/repos/${{ github.repository }}/releases \
              --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
              --header 'content-type: application/json' \
              --data '{
                "tag_name": "v${{ env.VERSION }}",
                "name": "v${{ env.VERSION }}",
                "body": "'"${{ env.RELEASE_NOTE }}"'",
                "draft": false,
                "prerelease": false,
                "generate_release_notes": true
              }'
          fi
